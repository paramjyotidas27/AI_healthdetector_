<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI Health Detector ‚Äî STD Checker </title>
<style>
:root{
  --bg:linear-gradient(180deg,#f4f8ff 0%, #eef6ff 100%);
  --blue1:#007bff; --blue2:#4cc3ff; --muted:#6b7280; --card:#fff;
  --accent:#e8f4ff; --danger:#e74c3c; --cap:85;
}
*{box-sizing:border-box;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
html,body{height:100%;margin:0;background:var(--bg);color:#0b2540}
header{background:linear-gradient(90deg,var(--blue1),var(--blue2));padding:48px 18px;color:#fff;text-align:center;box-shadow:0 8px 30px rgba(6,20,60,0.12)}
header h1{margin:0;font-size:28px;font-weight:800}
header p{margin:6px 0 0;color:rgba(255,255,255,0.95)}
main{max-width:1200px;margin:-30px auto 60px;padding:0 18px;display:grid;grid-template-columns:1fr 420px;gap:20px}
@media(max-width:980px){main{grid-template-columns:1fr} .aside{order:2}}
.card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(8,18,40,0.06);overflow:hidden}
.section-title{color:var(--blue1);font-weight:800;margin-bottom:10px}
label{display:block;margin-top:10px;color:var(--blue1);font-weight:700}
input[type="text"],input[type="number"],select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6f4ff;background:transparent;font-size:0.95rem;margin-top:6px}
select{appearance:none}
.row{display:flex;gap:12px}
.row>div{flex:1}
.small{font-size:0.9rem;color:var(--muted);margin-top:8px}
.sym-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
@media(max-width:640px){.sym-grid{grid-template-columns:1fr}}
.sym-box{background:linear-gradient(180deg,#fff,#fbfdff);padding:10px;border-radius:12px;border:1px solid #eef6ff;display:flex;align-items:center;justify-content:space-between}
.btn{background:linear-gradient(90deg,var(--blue1),var(--blue2));color:white;border:none;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.counter{display:flex;align-items:center;gap:8px}
.counter button{background:var(--blue1);color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}
.counter .num{min-width:56px;text-align:center;padding:6px;border-radius:8px;background:#f4fbff;border:1px solid #e6f4ff}
.gauge-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
.gauge{width:220px;height:220px;position:relative}
.gauge svg{width:100%;height:100%;transform:rotate(-90deg)}
.gauge .center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.gauge .big{font-size:34px;font-weight:900;color:var(--blue1)}
.gauge .tiny{font-size:12px;color:var(--muted)}
.disease-list{margin-top:12px;display:grid;gap:10px}
.d-card{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:12px;background:linear-gradient(180deg,#fff,#fcfeff);border:1px solid #eef7ff}
.icon{width:46px;height:46px;border-radius:10px;background:#f0fbff;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--blue1)}
.pct{font-weight:900;color:var(--blue1);font-size:18px}
.bar{height:8px;background:#eef6ff;border-radius:8px;overflow:hidden;margin-top:8px}
.bar .fill{height:100%;width:0;background:linear-gradient(90deg,#55a7ff,#56e0ff);transition:width 1.2s cubic-bezier(.2,.9,.2,1)}
.d-note{font-size:13px;color:var(--muted);margin-top:6px}
.urgent{display:none;margin-top:12px;background:#fff0f0;border-left:4px solid var(--danger);padding:12px;border-radius:10px;color:var(--danger);font-weight:800}
.links{margin-top:12px;font-size:14px}
.links a{color:var(--blue1);text-decoration:none;font-weight:700}

/* spinner overlay centered */
.spinner-overlay{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:1500;align-items:center;justify-content:center}
.spinner-card{background:linear-gradient(180deg,#fff,#fbfdff);padding:16px;border-radius:12px;display:flex;gap:12px;align-items:center;box-shadow:0 14px 40px rgba(2,6,23,0.35)}
.spinner{width:44px;height:44px;border-radius:50%;border:5px solid #e9f6ff;border-top-color:var(--blue1);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:26px;background:#111;color:white;padding:12px 16px;border-radius:10px;opacity:0;transition:opacity .26s,transform .26s;z-index:1600}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

/* feedback popup (glass) */
.popup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.35);backdrop-filter:blur(4px);z-index:1600}
.modal{background:rgba(255,255,255,0.95);padding:16px;border-radius:12px;width:92%;max-width:520px;box-shadow:0 12px 40px rgba(2,6,23,0.28)}
.modal h3{color:var(--blue1);margin:0 0 8px}
.modal textarea{width:100%;height:110px;border-radius:8px;padding:8px;border:1px solid #e6f4ff;margin-top:8px}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}
.fade-in{animation:fadeIn .5s ease both}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
</style>
</head>
<body>
<header>
  <h1>AI Health Detector ‚Äî STD Checker</h1>
  <p>Sexy. Private. Smart. Fill what you can ‚Äî partial answers work. No data = no result.</p>
</header>

<main>
  <!-- LEFT: form -->
  <div class="card" id="formCard">
    <div class="section-title">Your details</div>

    <label>Name (optional)</label>
    <input id="name" type="text" placeholder="Your name (optional)"/>

    <div class="row">
      <div>
        <label>Age</label>
        <input id="age" type="number" min="13" max="120" placeholder="e.g., 24"/>
      </div>
      <div>
        <label>Gender</label>
        <select id="gender">
          <option value="">Select</option>
          <option value="female">Female</option>
          <option value="male">Male</option>
          <option value="other">Other</option>
        </select>
      </div>
    </div>

    <label>Region (State)</label>
    <select id="region">
      <option value="">Select</option>
      <option>Maharashtra</option><option>Delhi</option><option>Uttar Pradesh</option>
      <option>West Bengal</option><option>Assam</option><option>Karnataka</option>
      <option>Tamil Nadu</option><option>Gujarat</option><option>Kerala</option>
      <option>Rajasthan</option><option>Bihar</option><option>Other</option>
    </select>

    <div style="height:10px"></div>
    <div class="section-title">Sexual history & risk</div>

    <label>Number of sexual partners (past 12 months)</label>
    <div class="counter">
      <button type="button" id="partnersMinus">‚àí</button>
      <div class="num" id="partnersCount">0</div>
      <button type="button" id="partnersPlus">+</button>
      <div class="small">Adjust partners (0 if none)</div>
    </div>

    <label style="margin-top:8px">Protection used (most recent)</label>
    <select id="protection">
      <option value="">Select</option>
      <option value="always">Always (consistent)</option>
      <option value="sometimes">Sometimes</option>
      <option value="never">Never</option>
    </select>

    <label style="margin-top:8px">Days since last sexual intercourse</label>
    <input id="lastSexDays" type="number" min="0" placeholder="0 = today, 1 = yesterday"/>

    <label style="margin-top:12px">Have you or a partner had an STD before?</label>
    <select id="prevStd">
      <option value="">Select</option>
      <option value="no">No</option>
      <option value="yes">Yes</option>
      <option value="not_sure">Not sure</option>
    </select>

    <label style="margin-top:12px">Partner history (known STD positive?)</label>
    <select id="partnerStd">
      <option value="">Select</option>
      <option value="no">No</option>
      <option value="yes">Yes</option>
      <option value="unknown">Unknown</option>
    </select>

    <div style="height:10px"></div>
    <div class="section-title">Symptoms (Yes / No)</div>
    <div class="sym-grid" id="symGrid">
      <!-- JS will inject symptom selects -->
    </div>

    <div style="height:10px"></div>
    <div class="section-title">Lifestyle & other risks</div>
    <label>Injection drug use?</label>
    <select id="injection"><option value="">Select</option><option value="no">No</option><option value="yes">Yes</option></select>

    <label style="margin-top:8px">Smoking / tobacco</label>
    <select id="smoke"><option value="">Select</option><option value="no">No</option><option value="occasional">Occasional</option><option value="yes">Yes</option></select>

    <label style="margin-top:8px">Alcohol use</label>
    <select id="alcohol"><option value="">Select</option><option value="no">No</option><option value="occasional">Occasional</option><option value="yes">Yes</option></select>

    <label style="margin-top:8px">Existing chronic illness (diabetes, etc.)</label>
    <select id="chronic"><option value="">Select</option><option value="no">No</option><option value="diabetes">Diabetes</option><option value="other">Other</option></select>

    <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
      <button id="analyzeBtn" class="btn">Show My Results</button>
      <div class="small">Hide your name if you prefer ‚Äî all data stays local to your browser.</div>
    </div>
  </div>

  <!-- RIGHT: result aside -->
  <aside class="aside card fade-in">
    <div class="section-title">Quick Result</div>
    <div class="small">If nothing is entered, results won't show. Fill any one field to allow analysis.</div>

    <div class="gauge-wrap" style="margin-top:12px">
      <div id="gaugeBox" class="gauge">
        <!-- SVG gauge injected -->
        <div class="center" style="pointer-events:none;position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
          <div class="big" id="overallPct">‚Äî%</div>
          <div class="tiny">Overall STD risk</div>
        </div>
      </div>

      <div id="topLine" class="small" style="text-align:center;color:var(--muted)">‚Äî</div>

      <div class="disease-list" id="diseaseList">
        <!-- per-STD cards inserted by JS -->
      </div>

      <div id="urgent" class="urgent">‚ö†Ô∏è Seek immediate medical consultation.</div>

      <div class="links">
        <div style="margin-top:12px"><strong>Consultation & resources</strong></div>
        <div style="margin-top:8px">
          HIV/Treatment & testing: <a href="https://nvf.in" target="_blank">National HIV services</a><br>
          STIs info & testing: <a href="https://main.mohfw.gov.in" target="_blank">Ministry of Health</a><br>
          Local: <a href="https://smcassam.ac.in" target="_blank">Silchar Medical College (SMCH)</a> ‚Äî Phone: <strong>+91 3842-246100</strong>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="feedbackOpen" class="btn" style="background:#0b79d0" disabled>Share Feedback</button>
        <button id="noThanks" class="btn" style="background:#f3f4f6;color:#222">‚ùå No, thanks</button>
      </div>
    </div>
  </aside>
</main>

<!-- spinner overlay -->
<div id="spinnerOverlay" class="spinner-overlay" aria-hidden="true">
  <div class="spinner-card">
    <div class="spinner" aria-hidden="true"></div>
    <div>
      <div style="font-weight:800;color:#0b2540">Analyzing your responses‚Ä¶</div>
      <div style="font-size:13px;color:var(--muted)">This is private ‚Äî calculations happen in your browser.</div>
    </div>
  </div>
</div>

<!-- toast -->
<div id="toast" class="toast">Please answer at least one question to analyze üíô</div>

<!-- feedback popup -->
<div id="feedbackPopup" class="popup" aria-hidden="true">
  <div class="modal">
    <h3>Share feedback</h3>
    <p style="margin:6px 0 10px;color:#333">Your feedback helps improve this tool. It‚Äôs stored locally unless you decide to share it.</p>
    <textarea id="feedbackText" placeholder="Type feedback (optional)"></textarea>
    <div class="actions">
      <button class="btn-ghost" onclick="closeFeedback()">Close</button>
      <button class="btn" onclick="submitFeedback()">Submit feedback</button>
    </div>
    <div id="fbSaved" style="display:none;margin-top:8px;color:var(--muted)">Thanks ‚Äî saved locally.</div>
  </div>
</div>

<div class="footer">¬© 2025 AI Health Detector ‚Äî PM SHRI KV Silchar</div>

<script>
/* ------------------ Setup: symptoms & STDs ------------------ */
const symptomList = [
  {id:'sym_urg_pain', text:'Pain or burning while urinating'},
  {id:'sym_discharge', text:'Unusual genital discharge'},
  {id:'sym_sores', text:'Sores, blisters, or ulcers near genitals'},
  {id:'sym_itch', text:'Persistent itching / irritation'},
  {id:'sym_pain_sex', text:'Pain during sexual intercourse'},
  {id:'sym_swelling', text:'Swelling in groin / lymph nodes'},
  {id:'sym_lower_pain', text:'Lower abdominal / pelvic pain'},
  {id:'sym_fever', text:'Fever, unexplained fatigue'},
  {id:'sym_rash', text:'Rash / red spots on body'},
  {id:'sym_testical', text:'Testicular pain / tenderness (males)'},
  {id:'sym_throat', text:'Sore throat / mouth ulcers'},
  {id:'sym_eye', text:'Eye irritation / conjunctivitis'},
  {id:'sym_irregular_periods', text:'Irregular menstrual cycles (female)'},
  {id:'sym_weight_loss', text:'Unexplained weight loss / night sweats'},
  {id:'sym_recent_unprotected', text:'Recent unprotected sexual contact'}
];

const stds = [
  {id:'hiv', name:'HIV/AIDS', icon:'üß¨'},
  {id:'gonorrhea', name:'Gonorrhea', icon:'üî¥'},
  {id:'syphilis', name:'Syphilis', icon:'üî∑'},
  {id:'chlamydia', name:'Chlamydia', icon:'üü£'},
  {id:'herpes', name:'Herpes (HSV)', icon:'üü†'}
];

/* inject symptom selects */
const symGrid = document.getElementById('symGrid');
symptomList.forEach(s => {
  const div = document.createElement('div');
  div.className = 'sym-box fade-in';
  const span = document.createElement('div'); span.style.flex='1'; span.textContent = s.text;
  const sel = document.createElement('select'); sel.id = s.id;
  sel.innerHTML = '<option value="">Select</option><option value="no">No</option><option value="yes">Yes</option>';
  div.appendChild(span); div.appendChild(sel);
  symGrid.appendChild(div);
});

/* inject STD cards */
const diseaseList = document.getElementById('diseaseList');
stds.forEach(d => {
  const el = document.createElement('div'); el.className = 'd-card fade-in'; el.id = 'card-'+d.id;
  el.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
    <div class="icon">${d.icon}</div>
    <div><div style="font-weight:800">${d.name}</div><div id="${d.id}-note" class="d-note"></div></div>
  </div>
  <div style="width:42%"><div style="display:flex;justify-content:space-between"><div id="${d.id}-pct" class="pct">‚Äî%</div></div>
  <div class="bar"><div id="${d.id}-fill" class="fill" style="width:0%"></div></div></div>`;
  diseaseList.appendChild(el);
});

/* gauge SVG */
const gaugeBox = document.getElementById('gaugeBox');
const gaugeSize = 220, gaugeStroke = 20, gaugeR = (gaugeSize - gaugeStroke)/2, gaugeCirc = 2*Math.PI*gaugeR;
const svgNS = "http://www.w3.org/2000/svg";
const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('width',gaugeSize); svg.setAttribute('height',gaugeSize);
const bgC = document.createElementNS(svgNS,'circle'); bgC.setAttribute('cx',gaugeSize/2); bgC.setAttribute('cy',gaugeSize/2); bgC.setAttribute('r',gaugeR); bgC.setAttribute('stroke','#eef6ff'); bgC.setAttribute('stroke-width',gaugeStroke); bgC.setAttribute('fill','none');
svg.appendChild(bgC);
const arc = document.createElementNS(svgNS,'circle'); arc.setAttribute('cx',gaugeSize/2); arc.setAttribute('cy',gaugeSize/2); arc.setAttribute('r',gaugeR); arc.setAttribute('stroke','url(#ggrad)'); arc.setAttribute('stroke-width',gaugeStroke); arc.setAttribute('fill','none'); arc.setAttribute('stroke-linecap','round'); arc.setAttribute('transform',`rotate(-90 ${gaugeSize/2} ${gaugeSize/2})`); arc.setAttribute('stroke-dasharray',gaugeCirc); arc.setAttribute('stroke-dashoffset',gaugeCirc);
const defs = document.createElementNS(svgNS,'defs'); const grad = document.createElementNS(svgNS,'linearGradient'); grad.setAttribute('id','ggrad'); grad.setAttribute('x1','0%'); grad.setAttribute('y1','0%'); grad.setAttribute('x2','100%'); grad.setAttribute('y2','0%');
const s1 = document.createElementNS(svgNS,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#00aaff');
const s2 = document.createElementNS(svgNS,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#4cc3ff');
grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad); svg.appendChild(defs); svg.appendChild(arc);
gaugeBox.appendChild(svg);

/* helpers */
function showToast(msg){
  const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3200);
}
function anyMeaningfulInput(){
  // check main fields
  const ids = ['name','age','gender','region','partnersCount','protection','lastSexDays','prevStd','partnerStd','injection','smoke','alcohol','chronic'];
  for(const id of ids){
    const el = document.getElementById(id);
    if(!el) continue;
    if(el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'){
      const v = String(el.value||'').trim();
      if(v !== '' && v !== '0') return true;
    }
  }
  // check partners numeric
  const p = Number(document.getElementById('partnersCount').innerText || 0);
  if(p>0) return true;
  // symptoms
  for(const s of symptomList){
    const el = document.getElementById(s.id);
    if(el && el.value && el.value !== '') return true;
  }
  return false;
}

/* partners counter */
let partners = 0;
document.getElementById('partnersPlus').addEventListener('click', ()=>{ partners++; document.getElementById('partnersCount').innerText = partners; });
document.getElementById('partnersMinus').addEventListener('click', ()=>{ partners = Math.max(0, partners-1); document.getElementById('partnersCount').innerText = partners; });

/* spinner and analyze behavior */
const spinner = document.getElementById('spinnerOverlay');
const analyzeBtn = document.getElementById('analyzeBtn');
analyzeBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  // hide previous results
  document.getElementById('urgent').style.display = 'none';
  // check inputs
  if(!anyMeaningfulInput()){
    showToast('Please answer at least one question to analyze üíô');
    return;
  }
  // show spinner
  spinner.style.display = 'flex';
  analyzeBtn.disabled = true;
  document.getElementById('feedbackOpen').disabled = true;
  await delay(2000); // 2s analyze vibe
  spinner.style.display = 'none';
  computeAndShow();
  analyzeBtn.disabled = false;
  document.getElementById('feedbackOpen').disabled = false;
});

/* compute scoring and show */
function computeAndShow(){
  // read inputs safely
  const age = Number(document.getElementById('age').value||0);
  const gender = String(document.getElementById('gender').value||'').toLowerCase();
  const region = String(document.getElementById('region').value||'');
  const partnersCount = Number(document.getElementById('partnersCount').innerText||0);
  const protection = String(document.getElementById('protection').value||'');
  const lastSexDays = Number(document.getElementById('lastSexDays').value||999);
  const prevStd = String(document.getElementById('prevStd').value||'');
  const partnerStd = String(document.getElementById('partnerStd').value||'');
  const injection = String(document.getElementById('injection').value||'');
  const smoke = String(document.getElementById('smoke').value||'');
  const alcohol = String(document.getElementById('alcohol').value||'');
  const chronic = String(document.getElementById('chronic').value||'');

  // read symptoms boolean map
  const S = {};
  symptomList.forEach(s => {
    const el = document.getElementById(s.id);
    S[s.id] = !!(el && el.value === 'yes');
  });

  // base raw scores per STD
  let raw = {hiv:0, gonorrhea:0, syphilis:0, chlamydia:0, herpes:0};

  // symptom weights (intuition-based)
  // Map each symptom to contributions for each STD
  const weightMap = {
    sym_urg_pain: {hiv:2, gonorrhea:10, syphilis:3, chlamydia:8, herpes:1},
    sym_discharge: {hiv:1, gonorrhea:12, syphilis:2, chlamydia:10, herpes:1},
    sym_sores: {hiv:3, gonorrhea:2, syphilis:12, chlamydia:1, herpes:10},
    sym_itch: {hiv:1, gonorrhea:4, syphilis:3, chlamydia:4, herpes:8},
    sym_pain_sex: {hiv:1, gonorrhea:6, syphilis:4, chlamydia:6, herpes:3},
    sym_swelling: {hiv:2, gonorrhea:6, syphilis:5, chlamydia:2, herpes:2},
    sym_lower_pain: {hiv:1, gonorrhea:6, syphilis:3, chlamydia:6, herpes:1},
    sym_fever: {hiv:5, gonorrhea:2, syphilis:4, chlamydia:1, herpes:3},
    sym_rash: {hiv:4, gonorrhea:1, syphilis:8, chlamydia:1, herpes:6},
    sym_testical: {hiv:1, gonorrhea:8, syphilis:2, chlamydia:6, herpes:1},
    sym_throat: {hiv:3, gonorrhea:3, syphilis:3, chlamydia:1, herpes:2},
    sym_eye: {hiv:2, gonorrhea:1, syphilis:2, chlamydia:1, herpes:1},
    sym_irregular_periods: {hiv:1, gonorrhea:1, syphilis:1, chlamydia:1, herpes:1},
    sym_weight_loss: {hiv:8, gonorrhea:2, syphilis:4, chlamydia:1, herpes:2},
    sym_recent_unprotected: {hiv:6, gonorrhea:6, syphilis:6, chlamydia:6, herpes:4}
  };

  // accumulate symptom contributions
  for(const s of symptomList){
    if(S[s.id]){
      const map = weightMap[s.id] || {};
      for(const k in map) raw[k] = (raw[k]||0) + map[k];
    }
  }

  // sexual behavior modifiers
  raw.hiv += partnersCount * 3;
  raw.gonorrhea += partnersCount * 2;
  raw.chlamydia += partnersCount * 2;
  if(protection === 'never'){ for(const k in raw) raw[k] += 6; }
  else if(protection === 'sometimes'){ for(const k in raw) raw[k] += 3; }

  // recent risky exposure increases HIV/Gonorrhea/Chlamydia a bit
  if(lastSexDays <= 7) { raw.hiv += 6; raw.gonorrhea +=4; raw.chlamydia +=4; }

  // partner STD knowledge
  if(partnerStd === 'yes'){ for(const k in raw) raw[k] += 8; }

  // previous STD to same disease (raise its estimate)
  if(prevStd === 'yes'){ raw.hiv += 6; raw.gonorrhea +=6; raw.syphilis +=6; }

  // injection drug use strongly raises HIV risk
  if(injection === 'yes'){ raw.hiv += 14; }

  // smoking/alcohol mild uplift for complications
  if(smoke === 'yes'){ raw.gonorrhea += 2; raw.syphilis +=2; }
  if(alcohol === 'yes'){ raw.hiv += 2; }

  // chronic disease minor adjustment
  if(chronic === 'diabetes'){ raw.hiv += 3; raw.syphilis +=2; }

  // demographic & region modifiers (small)
  if(['Maharashtra','Delhi','Uttar Pradesh'].includes(region)) { raw.gonorrhea += 3; raw.hiv += 2; }
  else if(['West Bengal','Karnataka','Tamil Nadu'].includes(region)) { raw.chlamydia += 2; raw.gonorrhea += 2; }

  // age factor
  if(age >= 15 && age <=30) { raw.chlamydia += 3; raw.gonorrhea += 3; }

  // baseline tiny noise to avoid zero-all
  for(const k in raw) raw[k] += 1 + Math.random()*2;

  // convert raw to relative percent
  const sumRaw = Object.values(raw).reduce((a,b)=>a+b,0) || 1;
  let rel = {};
  for(const k in raw) rel[k] = Math.round((raw[k]/sumRaw)*100);

  // overall factor based on symptom count and partners
  const symptomCount = Object.values(S).filter(Boolean).length;
  let overallFactor = Math.min(1.6, 0.6 + symptomCount*0.08 + (partnersCount>2?0.06:0) + (protection==='never'?0.04:0));

  for(const k in rel) rel[k] = Math.round(rel[k] * overallFactor);

  // scale down so none exceed cap (85)
  const cap = Number(getComputedStyle(document.documentElement).getPropertyValue('--cap')) || 85;
  const currentMax = Math.max(...Object.values(rel));
  const scale = currentMax === 0 ? 1 : Math.min(1, cap / currentMax);
  for(const k in rel) rel[k] = Math.round(rel[k] * scale);

  // pregnancy note: only relevant for females and not an STD but user wanted pregnancy logic earlier ‚Äî we do NOT treat pregnancy as STD.
  let pregnancyNote = '';
  if(gender === 'female' && document.getElementById('pregnantStatus')){
    const preg = document.getElementById('pregnantStatus') ? document.getElementById('pregnantStatus').value : '';
    if(preg === 'yes') pregnancyNote = 'Pregnancy suspected ‚Äî consult obstetrics in parallel.';
  }

  // compute overall as weighted average of STD probabilities + symptom boost
  const avg = Math.round(Object.values(rel).reduce((a,b)=>a+b,0) / Object.keys(rel).length);
  let overall = Math.round(avg + Math.min(12, symptomCount*2 + (partnersCount>3?4:0)));
  if(overall > cap) overall = cap;
  if(overall < 3) overall = 3;

  // update UI: gauge animate, cards, urgent, topLine
  animateGauge(overall);
  document.getElementById('overallPct').innerText = overall + '%';
  document.getElementById('topLine').innerText = `Most likely: ${getTopStd(rel)}`;

  // update each STD card
  stds.forEach(s=>{
    const pct = rel[s.id] || 0;
    document.getElementById(s.id + '-pct').innerText = pct + '%';
    document.getElementById(s.id + '-fill').style.width = pct + '%';
    document.getElementById(s.id + '-note').innerText = stdNote(s.id,pct);
  });

  // show urgent if any STD >= 70 or overall >= 70
  const urgent = document.getElementById('urgent');
  const anyHigh = Math.max(...Object.values(rel)) >= 70;
  if(overall > 70 || anyHigh) urgent.style.display = 'block'; else urgent.style.display = 'none';

  // show feedback enable
  document.getElementById('feedbackOpen').disabled = false;

  // final reveal: ensure aside visible (it already is)
}

/* small utilities */
function getTopStd(rel){
  let top = null, max = -1;
  for(const k in rel){ if(rel[k] > max){ max = rel[k]; top = k; } }
  const found = stds.find(s=>s.id===top);
  return found ? `${found.name} ‚Äî ${rel[top]}%` : '‚Äî';
}
function stdNote(id,pct){
  if(id==='hiv') return pct>40 ? 'Signs suggest higher HIV risk ‚Äî seek immediate testing & counselling.' : 'Low‚Äìmoderate HIV probability; testing recommended if exposed.';
  if(id==='gonorrhea') return pct>40 ? 'Genital discharge or pain point to Gonorrhea ‚Äî get tested & start treatment if positive.' : 'Monitor symptoms; test if persistent.';
  if(id==='syphilis') return pct>40 ? 'Sores or rash + risk factors ‚Äî test for Syphilis (RPR/VDRL).' : 'Low probability; test if suspicion persists.';
  if(id==='chlamydia') return pct>40 ? 'Common in young adults with discharge ‚Äî testing advised.' : 'Low‚Äìmoderate; consider testing if symptomatic.';
  if(id==='herpes') return pct>40 ? 'Blister-like sores point to Herpes ‚Äî seek clinical advice.' : 'Low probability; observe lesions and test if needed.';
  return '';
}

/* animate gauge */
async function animateGauge(target){
  const strokeLen = gaugeCirc;
  const offsetTarget = strokeLen - (target/100)*strokeLen;
  arc.style.transition = 'stroke-dashoffset 1200ms cubic-bezier(.2,.9,.2,1)';
  arc.style.strokeDashoffset = offsetTarget;
  // small numeric animation
  const el = document.getElementById('overallPct');
  const start = Number(el.innerText.replace('%','')) || 0;
  const steps = 30;
  for(let i=1;i<=steps;i++){
    const v = Math.round(start + (i/steps)*(target-start));
    el.innerText = v + '%';
    await delay( Math.round(1200/steps) );
  }
  el.innerText = target + '%';
}

/* delay util */
function delay(ms){ return new Promise(res=>setTimeout(res,ms)); }

/* top-level analyze trigger already wired; add pregnantStatus input dynamically (female only) */
(function wirePregnancyField(){
  const pregLabel = document.createElement('label'); pregLabel.style.marginTop = '8px';
  pregLabel.textContent = 'Are you currently pregnant or suspect pregnancy?';
  const pregSel = document.createElement('select'); pregSel.id = 'pregnantStatus';
  pregSel.innerHTML = '<option value="">Select</option><option value="no">No</option><option value="yes">Yes / Suspect</option><option value="not_sure">Not sure</option>';
  // insert after region select
  const regionEl = document.getElementById('region');
  regionEl.parentNode.insertBefore(pregLabel, regionEl.nextSibling);
  regionEl.parentNode.insertBefore(pregSel, pregLabel.nextSibling);
  // show/hide logic not necessary (we keep displayed), but pregnancy note used only if gender female
})();

/* feedback flows */
document.getElementById('feedbackOpen').addEventListener('click', ()=>{ document.getElementById('feedbackPopup').style.display='flex'; document.getElementById('feedbackPopup').setAttribute('aria-hidden','false'); });
document.getElementById('noThanks').addEventListener('click', ()=> showToast('No problem ‚Äî thanks for checking. Stay safe.') );
function closeFeedback(){ document.getElementById('feedbackPopup').style.display='none'; }
function submitFeedback(){
  const txt = document.getElementById('feedbackText').value.trim();
  const store = JSON.parse(localStorage.getItem('std_feedback_v4')||'[]');
  store.push({time:new Date().toISOString(), message:txt});
  localStorage.setItem('std_feedback_v4', JSON.stringify(store));
  document.getElementById('fbSaved').style.display = 'block';
  setTimeout(()=>{ document.getElementById('feedbackPopup').style.display='none'; document.getElementById('fbSaved').style.display='none'; showToast('Thanks ‚Äî feedback saved.'); }, 700);
}

/* initial state: disable feedback until a result */
document.getElementById('feedbackOpen').disabled = true;

/* utility: delay for initial gauge (set arc initial offset to full) */
arc.style.strokeDashoffset = gaugeCirc;

</script>
</body>
</html>
